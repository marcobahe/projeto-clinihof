generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Authentication models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// User roles for access control
enum UserRole {
  MASTER        // Platform owner - access to all workspaces and system management
  ADMIN         // Full access to everything
  MANAGER       // Access to reports, sales, appointments, patients (no system settings)
  USER          // Access to appointments, patients, own sales
  RECEPTIONIST  // Access to appointments, patients (read-only on financial data)
}

enum WorkspaceStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String
  fullName      String
  role          UserRole  @default(USER)
  workspaceId   String?   // Workspace that this user belongs to (for team members)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  accounts        Account[]
  sessions        Session[]
  ownedWorkspaces Workspace[] @relation("WorkspaceOwner")
  workspace       Workspace?  @relation("WorkspaceMembers", fields: [workspaceId], references: [id], onDelete: SetNull)
  
  @@index([workspaceId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Multi-tenant workspace model
model Workspace {
  id          String          @id @default(cuid())
  name        String          // Clinic name
  ownerId     String
  status      WorkspaceStatus @default(ACTIVE)
  plan        String          @default("free") // free, pro, enterprise
  maxUsers    Int             @default(5)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  owner         User             @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       User[]           @relation("WorkspaceMembers")
  patients      Patient[]
  procedures    Procedure[]
  sales         Sale[]
  supplies      Supply[]
  collaborators Collaborator[]
  costs         Cost[]
  packages      Package[]
  cardFeeRules  CardFeeRule[]
  quotes        Quote[]
}

// Supply model - Insumos da cl√≠nica
model Supply {
  id           String   @id @default(cuid())
  workspaceId  String
  name         String   // Nome do insumo (ex: "Toxina Botul√≠nica 50U")
  unit         String   // Unidade de medida (Frasco, Seringa, Par, Pacote, Aplica√ß√£o, Unidade)
  costPerUnit  Float    // Custo por unidade em R$
  stockQty     Int      @default(0) // Quantidade em estoque
  minStock     Int      @default(0) // Estoque m√≠nimo para alerta
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  workspace    Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  procedures   ProcedureSupply[]
  
  @@unique([workspaceId, name, unit]) // Evita duplica√ß√£o de insumos com mesmo nome + unidade
  @@index([workspaceId])
}

// Enum for commission type
enum CommissionType {
  PERCENTAGE  // Comiss√£o em percentual (%)
  FIXED       // Comiss√£o fixa em R$
}

// Collaborator model - Profissionais da cl√≠nica
model Collaborator {
  id               String          @id @default(cuid())
  workspaceId      String
  
  // Dados pessoais
  name             String          // Nome completo
  cpf              String?         // CPF
  rg               String?         // RG
  birthDate        DateTime?       // Data de nascimento
  phone            String?         // Telefone/WhatsApp
  email            String?         // E-mail
  address          String?         // Endere√ßo
  city             String?         // Cidade
  state            String?         // Estado (UF)
  zipCode          String?         // CEP
  
  // Dados profissionais
  role             String          // Fun√ß√£o (ex: "Esteticista", "M√©dico", "Assistente")
  admissionDate    DateTime?       // Data de admiss√£o
  isActive         Boolean         @default(true)
  
  // Dados financeiros
  baseSalary       Float           @default(0) // Sal√°rio base fixo mensal
  commissionType   CommissionType  @default(PERCENTAGE) // Tipo de comiss√£o
  commissionValue  Float           @default(0) // Valor ou % de comiss√£o
  charges          Float           @default(0) // Encargos fixos mensais (INSS, etc)
  monthlyHours     Int             @default(160) // Carga hor√°ria mensal
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  workspace        Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  procedures       ProcedureCollaborator[]
  quotes           Quote[]                 // Or√ßamentos criados por este profissional
  sales            Sale[]                  // Vendas realizadas por este colaborador
  
  @@index([workspaceId])
}

// Junction table: Procedure <-> Supply with quantity used
model ProcedureSupply {
  id           String    @id @default(cuid())
  procedureId  String
  supplyId     String
  quantity     Float     // Quantidade usada por procedimento
  
  procedure    Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  supply       Supply    @relation(fields: [supplyId], references: [id], onDelete: Cascade)
  
  @@unique([procedureId, supplyId])
  @@index([procedureId])
  @@index([supplyId])
}

// Junction table: Procedure <-> Collaborator with time spent
model ProcedureCollaborator {
  id             String       @id @default(cuid())
  procedureId    String
  collaboratorId String
  timeMinutes    Int          // Tempo em minutos gasto pelo profissional
  
  procedure      Procedure    @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  
  @@unique([procedureId, collaboratorId])
  @@index([procedureId])
  @@index([collaboratorId])
}

// Patient origin - Como o paciente conheceu a cl√≠nica
enum PatientOrigin {
  INSTAGRAM
  INDICACAO
  GOOGLE
  WHATSAPP
  FACEBOOK
  SITE
  OUTROS
}

// Patient model
model Patient {
  id          String         @id @default(cuid())
  workspaceId String
  name        String
  email       String?
  phone       String         // WhatsApp/Phone (required)
  birthday    DateTime?      // Data de anivers√°rio
  origin      PatientOrigin? // Como conheceu a cl√≠nica
  notes       String?        @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sales        Sale[]
  quotes       Quote[]
  
  @@unique([workspaceId, name, phone]) // Evita duplica√ß√£o de pacientes com mesmo nome + telefone
  @@index([workspaceId])
  @@index([birthday])
}

// Procedure model - Procedimentos est√©ticos com custo detalhado
model Procedure {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  price       Float    // Pre√ßo de venda em R$
  duration    Int      // Dura√ß√£o m√©dia em minutos
  fixedCost   Float?   @default(0) // Custo fixo do procedimento em R$
  color       String?  // Cor para exibi√ß√£o no calend√°rio (hex code)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  workspace      Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  sessions       ProcedureSession[]
  supplies       ProcedureSupply[]       // Insumos usados no procedimento
  collaborators  ProcedureCollaborator[] // Profissionais envolvidos
  packageItems   PackageItem[]           // Pacotes que incluem este procedimento
  quoteItems     QuoteItem[]             // Or√ßamentos que incluem este procedimento
  
  @@index([workspaceId])
}

// Sale model - Represents the financial transaction (Venda/Negocia√ß√£o)
model Sale {
  id               String        @id @default(cuid())
  workspaceId      String
  patientId        String
  sellerId         String?       // Vendedor/Colaborador respons√°vel pela venda
  packageId        String?       // Pacote vendido (quando venda √© de pacote)
  saleDate         DateTime      @default(now()) // Data da venda
  totalAmount      Float         // Valor total cobrado
  paymentMethod    PaymentMethod? // Forma de pagamento (deprecated - usar PaymentSplit)
  installments     Int           @default(1) // N√∫mero de parcelas (deprecated - usar PaymentSplit)
  paymentStatus    PaymentStatus @default(PENDING)
  notes            String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  
  workspace        Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  patient          Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  seller           Collaborator?      @relation(fields: [sellerId], references: [id])
  package          Package?           @relation(fields: [packageId], references: [id])
  items            SaleItem[]         // Procedimentos inclu√≠dos na venda
  sessions         ProcedureSession[] // Sess√µes de execu√ß√£o
  paymentSplits    PaymentSplit[]     // Split de pagamentos (nova feature)
  
  @@index([workspaceId])
  @@index([patientId])
  @@index([sellerId])
  @@index([packageId])
  @@index([saleDate])
}

// Sale Item - Procedures included in the sale with quantity (pacotes)
model SaleItem {
  id            String   @id @default(cuid())
  saleId        String
  procedureId   String
  quantity      Int      // Quantidade de sess√µes compradas
  unitPrice     Float    // Pre√ßo unit√°rio no momento da venda
  
  sale          Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  procedure     Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  @@index([saleId])
}

// Payment Split - Representa cada forma de pagamento em uma venda
model PaymentSplit {
  id              String        @id @default(cuid())
  saleId          String
  paymentMethod   PaymentMethod // Forma de pagamento deste split
  amount          Float         // Valor total deste split em R$
  installments    Int           @default(1) // N√∫mero de parcelas (1 = √† vista)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  sale            Sale                  @relation(fields: [saleId], references: [id], onDelete: Cascade)
  installmentDetails PaymentInstallment[] // Detalhes de cada parcela
  
  @@index([saleId])
}

// Payment Installment - Representa cada parcela de um PaymentSplit
model PaymentInstallment {
  id                String        @id @default(cuid())
  paymentSplitId    String
  installmentNumber Int           // N√∫mero da parcela (1, 2, 3...)
  amount            Float         // Valor desta parcela em R$
  dueDate           DateTime?     // Data de vencimento/recebimento esperado
  receivedDate      DateTime?     // Data em que foi efetivamente recebido
  status            PaymentStatus @default(PENDING) // Status desta parcela
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  paymentSplit      PaymentSplit  @relation(fields: [paymentSplitId], references: [id], onDelete: Cascade)
  
  @@unique([paymentSplitId, installmentNumber]) // Evita duplica√ß√£o de n√∫meros de parcela
  @@index([paymentSplitId])
  @@index([dueDate])
  @@index([status])
}

// Procedure Session - Execution of individual sessions (Sess√µes de Execu√ß√£o)
model ProcedureSession {
  id              String           @id @default(cuid())
  saleId          String
  procedureId     String
  collaboratorId  String?          // Profissional respons√°vel pela sess√£o
  scheduledDate   DateTime?        // Data agendada para a sess√£o
  completedDate   DateTime?        // Data de conclus√£o
  status          SessionStatus    @default(PENDING)
  appointmentType AppointmentType? // Tipo de consulta (primeira consulta, pend√™ncia, retorno)
  googleEventId   String?          // ID do evento no Google Calendar para sync
  notes           String?          @db.Text
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  procedure     Procedure     @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  @@index([saleId])
  @@index([scheduledDate])
  @@index([status])
  @@index([appointmentType])
  @@index([googleEventId])
}

enum PaymentMethod {
  CASH_PIX      // Dinheiro / Pix
  CREDIT_CARD   // Cart√£o de Cr√©dito
  DEBIT_CARD    // Cart√£o de D√©bito
  BANK_SLIP     // Boleto
}

enum PaymentStatus {
  PENDING       // Pendente
  PARTIAL       // Parcialmente pago
  PAID          // Pago
  OVERDUE       // Atrasado
}

enum SessionStatus {
  PENDING       // Sess√£o pendente
  SCHEDULED     // Agendada
  COMPLETED     // Conclu√≠da
  CANCELLED     // Cancelada
}

enum AppointmentType {
  FIRST_VISIT      // üî¥ Primeira Consulta - Paciente novo
  PAYMENT_PENDING  // üü° Pend√™ncia Financeira - Cobran√ßa em aberto
  FOLLOW_UP        // üü¢ Retorno/Acompanhamento - Continuidade do tratamento
}

enum CostType {
  FIXED       // Valor fixo em reais
  PERCENTAGE  // Percentual sobre vendas
}

enum CostCategory {
  OPERATIONAL // Custos operacionais (aluguel, energia, etc)
  TAX         // Impostos e taxas
  COMMISSION  // Comiss√µes
  CARD        // Taxas de cart√£o
  CUSTOM      // Categoria customizada
}

enum RecurrenceType {
  INDEFINITE    // Recorr√™ncia por prazo indeterminado (continua todo m√™s)
  INSTALLMENTS  // Parcelado (n√∫mero fixo de parcelas - ex: 10x, 12x)
}

// Cost model - Custos fixos e vari√°veis da cl√≠nica
model Cost {
  id             String          @id @default(cuid())
  workspaceId    String
  description    String          // Descri√ß√£o do custo (ex: "Aluguel Cl√≠nica", "Imposto ICMS")
  costType       CostType        // FIXED ou PERCENTAGE
  category       CostCategory    @default(OPERATIONAL) // Categoria do custo
  customCategory String?         // Nome da categoria customizada (usado quando category = CUSTOM)
  
  // Valor fixo mensal (usado quando costType = FIXED)
  fixedValue     Float?          // Valor em R$
  
  // Percentual sobre vendas (usado quando costType = PERCENTAGE)
  percentage     Float?          // Percentual (ex: 5.5 para 5.5%)
  
  // Campos espec√≠ficos para taxas de cart√£o (usado quando category = CARD)
  cardOperator   String?         // Operadora do cart√£o (ex: "Cielo", "Stone", "PagSeguro")
  receivingDays  Int?            // Prazo de recebimento em dias (ex: 30 dias)
  
  paymentDate    DateTime?       // Data de pagamento da despesa (opcional)
  isRecurring    Boolean         @default(true) // Se √© recorrente mensal
  isActive       Boolean         @default(true) // Se est√° ativo
  
  // Campos para recorr√™ncia autom√°tica
  recurrenceFrequency String?    @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  nextRecurrenceDate DateTime?   // Pr√≥xima data de lan√ßamento autom√°tico
  
  // Campos para custos parcelados
  recurrenceType     RecurrenceType @default(INDEFINITE) // Tipo de recorr√™ncia
  totalInstallments  Int?           // N√∫mero total de parcelas (usado quando recurrenceType = INSTALLMENTS)
  currentInstallment Int?           @default(0) // Parcela atual (0 = n√£o iniciado, 1-N = em andamento)
  
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  
  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  installments   CostInstallment[] // Parcelas do custo (quando parcelado)
  
  @@index([workspaceId])
  @@index([costType])
  @@index([isActive])
  @@index([nextRecurrenceDate])
}

// Cost Installment - Representa cada parcela de um custo fixo parcelado
model CostInstallment {
  id                String        @id @default(cuid())
  costId            String
  installmentNumber Int           // N√∫mero da parcela (1, 2, 3...)
  amount            Float         // Valor desta parcela em R$
  dueDate           DateTime      // Data de vencimento
  paidDate          DateTime?     // Data em que foi efetivamente pago
  status            PaymentStatus @default(PENDING) // Status desta parcela
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  cost              Cost          @relation(fields: [costId], references: [id], onDelete: Cascade)
  
  @@unique([costId, installmentNumber]) // Evita duplica√ß√£o de n√∫meros de parcela
  @@index([costId])
  @@index([dueDate])
  @@index([status])
}

// Card Fee Rule - Taxas de cart√£o diferenciadas por quantidade de parcelas
model CardFeeRule {
  id              String   @id @default(cuid())
  workspaceId     String
  costId          String?  // Link para o custo de cart√£o (Cost com category=CARD) - opcional
  cardOperator    String   @default("Rede") // Nome da operadora (ex: "Rede", "Stone", "PagSeguro")
  cardType        String   @default("CREDIT") // Tipo do cart√£o: "DEBIT" ou "CREDIT"
  installmentCount Int     @default(1) // N√∫mero exato de parcelas (ex: 1, 2, 3, etc)
  feePercentage   Float    // Taxa percentual (ex: 1.5 para 1,5%)
  receivingDays   Int      @default(30) // Prazo de recebimento em dias (ex: 30)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  @@index([workspaceId])
  @@index([isActive])
}

// Package model - Pacotes promocionais de procedimentos
model Package {
  id              String          @id @default(cuid())
  workspaceId     String
  name            String          // Nome do pacote (ex: "Protocolo Noiva Completo")
  finalPrice      Float           // Pre√ßo final do pacote em R$
  discountPercent Float           @default(0) // Desconto percentual aplicado
  isActive        Boolean         @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  items           PackageItem[]   // Procedimentos inclu√≠dos no pacote
  sales           Sale[]          // Vendas que usaram este pacote
  
  @@index([workspaceId])
  @@index([isActive])
}

// PackageItem - Procedimentos inclu√≠dos em um pacote
model PackageItem {
  id            String      @id @default(cuid())
  packageId     String
  procedureId   String
  quantity      Int         @default(1) // Quantidade de sess√µes do procedimento
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  package       Package     @relation(fields: [packageId], references: [id], onDelete: Cascade)
  procedure     Procedure   @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  @@unique([packageId, procedureId])
  @@index([packageId])
  @@index([procedureId])
}

// Quote model - Or√ßamentos/Propostas para pacientes
enum QuoteStatus {
  PENDING    // Pendente (aguardando resposta)
  SENT       // Enviado ao paciente
  ACCEPTED   // Aceito (convertido em venda)
  REJECTED   // Rejeitado
  EXPIRED    // Expirado
}

model Quote {
  id                String      @id @default(cuid())
  workspaceId       String
  patientId         String
  collaboratorId    String?     // Profissional respons√°vel pelo or√ßamento
  title             String      // T√≠tulo do or√ßamento (ex: "Tratamento Facial")
  totalAmount       Float       // Valor total do or√ßamento
  discountPercent   Float       @default(0) // Desconto aplicado (%)
  discountAmount    Float       @default(0) // Desconto em R$
  finalAmount       Float       // Valor final com desconto
  
  status            QuoteStatus @default(PENDING)
  notes             String?     @db.Text // Observa√ß√µes
  
  // Tracking de convers√£o
  createdDate       DateTime    @default(now()) // Data de cria√ß√£o
  sentDate          DateTime?   // Data de envio ao paciente
  expirationDate    DateTime?   // Data de validade
  acceptedDate      DateTime?   // Data de aceite
  rejectedDate      DateTime?   // Data de rejei√ß√£o
  saleId            String?     @unique // ID da venda (se convertido)
  
  // Origem do lead
  leadSource        String?     // Origem do paciente (Instagram, Google, Indica√ß√£o, etc)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  workspace         Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  patient           Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)
  collaborator      Collaborator? @relation(fields: [collaboratorId], references: [id])
  items             QuoteItem[]
  
  @@index([workspaceId])
  @@index([patientId])
  @@index([collaboratorId])
  @@index([status])
  @@index([createdDate])
  @@index([leadSource])
}

// QuoteItem - Procedimentos inclu√≠dos no or√ßamento
model QuoteItem {
  id            String      @id @default(cuid())
  quoteId       String
  procedureId   String?     // Opcional: pode ser um procedimento customizado
  description   String      // Descri√ß√£o do item
  quantity      Int         @default(1) // Quantidade de sess√µes
  unitPrice     Float       // Pre√ßo unit√°rio
  totalPrice    Float       // Pre√ßo total (quantidade √ó unitPrice)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  quote         Quote       @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  procedure     Procedure?  @relation(fields: [procedureId], references: [id])
  
  @@index([quoteId])
  @@index([procedureId])
}


// WorkspaceSettings - Configura√ß√µes da cl√≠nica/workspace
model WorkspaceSettings {
  id                    String    @id @default(cuid())
  workspaceId           String    @unique
  
  // Custos fixos da cl√≠nica
  monthlyFixedCosts     Float     @default(0) // Total de custos fixos mensais em R$
  monthlyWorkingHours   Float     @default(176) // Horas trabalhadas por m√™s (22 dias √ó 8h)
  hourlyClinicCost      Float?    // Custo por hora da cl√≠nica (calculado: monthlyFixedCosts / monthlyWorkingHours)
  
  // Google Calendar sync settings
  googleCalendarEnabled Boolean   @default(false) // Se a sincroniza√ß√£o est√° ativa
  googleCalendarId      String?   // ID do calend√°rio Google a sincronizar
  googleSyncToken       String?   // Token para sync incremental
  lastGoogleSync        DateTime? // √öltima sincroniza√ß√£o
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([workspaceId])
}
